<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleKernel: SimpleKernel æ–‡ä»¶ç³»ç»Ÿè®¾è®¡è§„åˆ’</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SimpleKernel<span id="projectnumber">&#160;1.17.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_filesystem__design.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">SimpleKernel æ–‡ä»¶ç³»ç»Ÿè®¾è®¡è§„åˆ’</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md252"></a> </p>
<h1><a class="anchor" id="autotoc_md253"></a>
1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¡£è§„åˆ’ SimpleKernel çš„æ–‡ä»¶ç³»ç»Ÿå­ç³»ç»Ÿï¼ŒåŒ…å«ä»¥ä¸‹ 5 ä¸ªæ¨¡å—ï¼ŒæŒ‰ä¾èµ–å…³ç³»è‡ªåº•å‘ä¸Šå®ç°ï¼š</p>
<div class="fragment"><div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚              ç”¨æˆ·æ¥å£ (syscall)                    â”‚</div>
<div class="line">â”‚     open / close / read / write / mount          â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚                VFS å±‚                             â”‚</div>
<div class="line">â”‚  Superblock Â· Inode Â· Dentry Â· File Â· MountTable â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚       ramfs          â”‚         fat32             â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚              å—è®¾å¤‡æŠ½è±¡å±‚                          â”‚</div>
<div class="line">â”‚            BlockDevice æ¥å£                       â”‚</div>
<div class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</div>
<div class="line">â”‚          virtio-blk é©±åŠ¨                          â”‚</div>
<div class="line">â”‚     MMIO transport Â· VirtQueue Â· è¯·æ±‚å¤„ç†         â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md254"></a>
å®ç°ä¼˜å…ˆçº§ä¸ä¾èµ–é“¾</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">é˜¶æ®µ   </th><th class="markdownTableHeadNone">æ¨¡å—   </th><th class="markdownTableHeadNone">ä¾èµ–   </th><th class="markdownTableHeadNone">äº§å‡º    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">P0   </td><td class="markdownTableBodyNone">å—è®¾å¤‡æ¥å£ + virtio-blk é©±åŠ¨   </td><td class="markdownTableBodyNone">FDT è§£æã€MMIOã€ä¸­æ–­   </td><td class="markdownTableBodyNone">èƒ½è¯»å†™ QEMU ç£ç›˜æ‰‡åŒº    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">P1   </td><td class="markdownTableBodyNone">VFS æ¡†æ¶   </td><td class="markdownTableBodyNone">æ— å¤–éƒ¨ä¾èµ–   </td><td class="markdownTableBodyNone">inode/dentry/file æŠ½è±¡    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">P2   </td><td class="markdownTableBodyNone">ramfs   </td><td class="markdownTableBodyNone">VFS   </td><td class="markdownTableBodyNone">å†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼ŒéªŒè¯ VFS æ­£ç¡®æ€§    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">P3   </td><td class="markdownTableBodyNone">FAT32   </td><td class="markdownTableBodyNone">VFS + å—è®¾å¤‡   </td><td class="markdownTableBodyNone">èƒ½è¯»å†™ QEMU ç£ç›˜ä¸Šçš„ FAT32 åˆ†åŒº    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">P4   </td><td class="markdownTableBodyNone">ç³»ç»Ÿè°ƒç”¨é›†æˆ   </td><td class="markdownTableBodyNone">VFS + ä»»åŠ¡ç®¡ç†   </td><td class="markdownTableBodyNone">open/close/read/write/mount   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md256"></a>
2. ç›®å½•ç»“æ„</h1>
<div class="fragment"><div class="line">src/</div>
<div class="line">â”œâ”€â”€ fs/                              # ğŸ“ æ–°å¢ï¼šæ–‡ä»¶ç³»ç»Ÿå­ç³»ç»Ÿ</div>
<div class="line">â”‚   â”œâ”€â”€ CMakeLists.txt</div>
<div class="line">â”‚   â”œâ”€â”€ include/                     # ğŸ“ æ¥å£å¤´æ–‡ä»¶</div>
<div class="line">â”‚   â”‚   â”œâ”€â”€ block_device.hpp         # å—è®¾å¤‡æŠ½è±¡æ¥å£</div>
<div class="line">â”‚   â”‚   â”œâ”€â”€ vfs.hpp                  # VFS æ ¸å¿ƒæ•°æ®ç»“æ„</div>
<div class="line">â”‚   â”‚   â”œâ”€â”€ filesystem.hpp           # æ–‡ä»¶ç³»ç»ŸåŸºç±»æ¥å£</div>
<div class="line">â”‚   â”‚   â”œâ”€â”€ file_descriptor.hpp      # æ–‡ä»¶æè¿°ç¬¦è¡¨</div>
<div class="line">â”‚   â”‚   â””â”€â”€ mount.hpp                # æŒ‚è½½ç®¡ç†</div>
<div class="line">â”‚   â”œâ”€â”€ vfs.cpp                      # VFS å®ç°</div>
<div class="line">â”‚   â”œâ”€â”€ file_descriptor.cpp          # æ–‡ä»¶æè¿°ç¬¦è¡¨å®ç°</div>
<div class="line">â”‚   â”œâ”€â”€ mount.cpp                    # æŒ‚è½½ç®¡ç†å®ç°</div>
<div class="line">â”‚   â”œâ”€â”€ ramfs/                       # ramfs æ–‡ä»¶ç³»ç»Ÿ</div>
<div class="line">â”‚   â”‚   â”œâ”€â”€ CMakeLists.txt</div>
<div class="line">â”‚   â”‚   â”œâ”€â”€ include/</div>
<div class="line">â”‚   â”‚   â”‚   â””â”€â”€ ramfs.hpp            # ğŸ“ ramfs æ¥å£</div>
<div class="line">â”‚   â”‚   â””â”€â”€ ramfs.cpp                # ramfs å®ç°</div>
<div class="line">â”‚   â””â”€â”€ fat32/                       # FAT32 æ–‡ä»¶ç³»ç»Ÿ</div>
<div class="line">â”‚       â”œâ”€â”€ CMakeLists.txt</div>
<div class="line">â”‚       â”œâ”€â”€ include/</div>
<div class="line">â”‚       â”‚   â””â”€â”€ fat32.hpp            # ğŸ“ FAT32 æ¥å£</div>
<div class="line">â”‚       â””â”€â”€ fat32.cpp                # FAT32 å®ç°</div>
<div class="line">â”œâ”€â”€ driver/</div>
<div class="line">â”‚   â”œâ”€â”€ virtio/                      # ğŸ“ æ–°å¢ï¼švirtio é©±åŠ¨</div>
<div class="line">â”‚   â”‚   â”œâ”€â”€ CMakeLists.txt</div>
<div class="line">â”‚   â”‚   â”œâ”€â”€ include/</div>
<div class="line">â”‚   â”‚   â”‚   â”œâ”€â”€ virtio.hpp           # ğŸ“ virtio é€šç”¨æ¥å£</div>
<div class="line">â”‚   â”‚   â”‚   â””â”€â”€ virtio_blk.hpp       # ğŸ“ virtio-blk æ¥å£</div>
<div class="line">â”‚   â”‚   â”œâ”€â”€ virtio.cpp               # virtio MMIO transport å®ç°</div>
<div class="line">â”‚   â”‚   â””â”€â”€ virtio_blk.cpp           # virtio-blk é©±åŠ¨å®ç°</div>
<div class="line">tests/</div>
<div class="line">â”œâ”€â”€ unit_test/</div>
<div class="line">â”‚   â”œâ”€â”€ vfs_test.cpp                 # VFS å•å…ƒæµ‹è¯•</div>
<div class="line">â”‚   â”œâ”€â”€ ramfs_test.cpp               # ramfs å•å…ƒæµ‹è¯•</div>
<div class="line">â”‚   â””â”€â”€ fat32_test.cpp               # FAT32 å•å…ƒæµ‹è¯•ï¼ˆç”¨ mock å—è®¾å¤‡ï¼‰</div>
<div class="line">â”œâ”€â”€ system_test/</div>
<div class="line">â”‚   â”œâ”€â”€ fs_test.cpp                  # æ–‡ä»¶ç³»ç»Ÿé›†æˆæµ‹è¯•ï¼ˆQEMU å†…è¿è¡Œï¼‰</div>
<div class="line">â”‚   â””â”€â”€ virtio_blk_test.cpp          # virtio-blk é©±åŠ¨ç³»ç»Ÿæµ‹è¯•</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md258"></a>
3. æ¥å£è®¾è®¡</h1>
<h2><a class="anchor" id="autotoc_md259"></a>
3.1 å—è®¾å¤‡æ¥å£ (&lt;tt&gt;block_device.hpp&lt;/tt&gt;)</h2>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">class </span>BlockDevice {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">virtual</span> ~BlockDevice() = <span class="keywordflow">default</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keyword">auto</span> ReadSectors(uint64_t sector_start, uint32_t sector_count,</div>
<div class="line">                           <span class="keywordtype">void</span>* buffer) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;size_t&gt;</a> = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keyword">auto</span> WriteSectors(uint64_t sector_start, uint32_t sector_count,</div>
<div class="line">                            <span class="keyword">const</span> <span class="keywordtype">void</span>* buffer) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;size_t&gt;</a> = 0;</div>
<div class="line"> </div>
<div class="line">  [[nodiscard]] <span class="keyword">virtual</span> <span class="keyword">auto</span> GetSectorSize() const -&gt; uint32_t = 0;</div>
<div class="line"> </div>
<div class="line">  [[nodiscard]] virtual auto GetSectorCount() const -&gt; uint64_t = 0;</div>
<div class="line"> </div>
<div class="line">  [[nodiscard]] virtual auto GetName() const -&gt; const <span class="keywordtype">char</span>* = 0;</div>
<div class="line">};</div>
<div class="ttc" id="aexpected_8hpp_html_a87330dc74eb67e824914b8d343050757"><div class="ttname"><a href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected</a></div><div class="ttdeci">std::expected&lt; T, Error &gt; Expected</div><div class="ttdoc">std::expected åˆ«åæ¨¡æ¿</div><div class="ttdef"><b>Definition</b> <a href="expected_8hpp_source.html#l00162">expected.hpp:162</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md260"></a>
3.2 VFS æ ¸å¿ƒæ•°æ®ç»“æ„ (&lt;tt&gt;vfs.hpp&lt;/tt&gt;)</h2>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">enum class</span> FileType : uint8_t {</div>
<div class="line">  kRegular = 1,    </div>
<div class="line">  kDirectory = 2,  </div>
<div class="line">  kCharDevice = 3, </div>
<div class="line">  kBlockDevice = 4,</div>
<div class="line">  kSymlink = 5,    </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">enum</span> OpenFlags : uint32_t {</div>
<div class="line">  kOReadOnly  = 0x0000,</div>
<div class="line">  kOWriteOnly = 0x0001,</div>
<div class="line">  kOReadWrite = 0x0002,</div>
<div class="line">  kOCreate    = 0x0040,</div>
<div class="line">  kOTruncate  = 0x0200,</div>
<div class="line">  kOAppend    = 0x0400,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">enum class</span> SeekWhence : <span class="keywordtype">int</span> {</div>
<div class="line">  kSet = 0,  </div>
<div class="line">  kCur = 1,  </div>
<div class="line">  kEnd = 2,  </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>Inode {</div>
<div class="line">  uint64_t ino;           </div>
<div class="line">  FileType type;          </div>
<div class="line">  uint64_t size;          </div>
<div class="line">  uint32_t permissions;   </div>
<div class="line">  uint32_t link_count;    </div>
<div class="line">  <span class="keywordtype">void</span>* fs_private;       </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">struct </span>InodeOps {</div>
<div class="line">    <span class="keyword">auto</span> (*lookup)(Inode* dir, <span class="keyword">const</span> <span class="keywordtype">char</span>* name) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;Inode*&gt;</a>;</div>
<div class="line">    <span class="keyword">auto</span> (*create)(Inode* dir, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, FileType type) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;Inode*&gt;</a>;</div>
<div class="line">    <span class="keyword">auto</span> (*unlink)(Inode* dir, <span class="keyword">const</span> <span class="keywordtype">char</span>* name) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;void&gt;</a>;</div>
<div class="line">    <span class="keyword">auto</span> (*mkdir)(Inode* dir, <span class="keyword">const</span> <span class="keywordtype">char</span>* name) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;Inode*&gt;</a>;</div>
<div class="line">    <span class="keyword">auto</span> (*rmdir)(Inode* dir, <span class="keyword">const</span> <span class="keywordtype">char</span>* name) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;void&gt;</a>;</div>
<div class="line">  } *ops = <span class="keyword">nullptr</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>Dentry {</div>
<div class="line">  <span class="keywordtype">char</span> name[256];          </div>
<div class="line">  Inode* inode;            </div>
<div class="line">  Dentry* parent;          </div>
<div class="line">  Dentry* children;        </div>
<div class="line">  Dentry* next_sibling;    </div>
<div class="line">  <span class="keywordtype">void</span>* fs_private;        </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>File {</div>
<div class="line">  Inode* inode;           </div>
<div class="line">  Dentry* dentry;         </div>
<div class="line">  uint64_t offset;        </div>
<div class="line">  uint32_t <a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a>;         </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">struct </span>FileOps {</div>
<div class="line">    <span class="keyword">auto</span> (*read)(File* file, <span class="keywordtype">void</span>* buf, <span class="keywordtype">size_t</span> count) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;size_t&gt;</a>;</div>
<div class="line">    <span class="keyword">auto</span> (*write)(File* file, <span class="keyword">const</span> <span class="keywordtype">void</span>* buf, <span class="keywordtype">size_t</span> count) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;size_t&gt;</a>;</div>
<div class="line">    <span class="keyword">auto</span> (*seek)(File* file, int64_t offset, SeekWhence whence) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;uint64_t&gt;</a>;</div>
<div class="line">    <span class="keyword">auto</span> (*close)(File* file) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;void&gt;</a>;</div>
<div class="line">    <span class="keyword">auto</span> (*readdir)(File* file, <span class="keywordtype">void</span>* dirent, <span class="keywordtype">size_t</span> count) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;size_t&gt;</a>;</div>
<div class="line">  } *ops = <span class="keyword">nullptr</span>;</div>
<div class="line">};</div>
<div class="ttc" id="aacpi_8h_html_a773b39d480759f67926cb18ae2219281"><div class="ttname"><a href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a></div><div class="ttdeci">uint32_t flags</div><div class="ttdef"><b>Definition</b> <a href="acpi_8h_source.html#l00038">acpi.h:38</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md261"></a>
3.3 æ–‡ä»¶ç³»ç»ŸåŸºç±» (&lt;tt&gt;filesystem.hpp&lt;/tt&gt;)</h2>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">class </span>FileSystem {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">virtual</span> ~FileSystem() = <span class="keywordflow">default</span>;</div>
<div class="line"> </div>
<div class="line">  [[nodiscard]] <span class="keyword">virtual</span> <span class="keyword">auto</span> GetName() const -&gt; const <span class="keywordtype">char</span>* = 0;</div>
<div class="line"> </div>
<div class="line">  virtual auto Mount(BlockDevice* device) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected</a>&lt;Inode*&gt; = 0;</div>
<div class="line"> </div>
<div class="line">  virtual auto Unmount() -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected</a>&lt;<span class="keywordtype">void</span>&gt; = 0;</div>
<div class="line"> </div>
<div class="line">  virtual auto Sync() -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected</a>&lt;<span class="keywordtype">void</span>&gt; = 0;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md262"></a>
3.4 æŒ‚è½½ç®¡ç† (&lt;tt&gt;mount.hpp&lt;/tt&gt;)</h2>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">struct </span>MountPoint {</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span>* mount_path;     </div>
<div class="line">  Dentry* mount_dentry;       </div>
<div class="line">  FileSystem* filesystem;     </div>
<div class="line">  BlockDevice* device;        </div>
<div class="line">  Inode* root_inode;          </div>
<div class="line">  Dentry* root_dentry;        </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>MountTable {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keywordtype">size_t</span> kMaxMounts = 16;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> Mount(<span class="keyword">const</span> <span class="keywordtype">char</span>* path, FileSystem* fs, BlockDevice* device)</div>
<div class="line">      -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;void&gt;</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> Unmount(<span class="keyword">const</span> <span class="keywordtype">char</span>* path) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;void&gt;</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> Lookup(<span class="keyword">const</span> <span class="keywordtype">char</span>* path) -&gt; MountPoint*;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md263"></a>
3.5 æ–‡ä»¶æè¿°ç¬¦è¡¨ (&lt;tt&gt;file_descriptor.hpp&lt;/tt&gt;)</h2>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">class </span>FdTable {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keywordtype">int</span> kMaxFd = 64;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> Alloc(File* file) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;int&gt;</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> Get(<span class="keywordtype">int</span> fd) -&gt; File*;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> Free(<span class="keywordtype">int</span> fd) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;void&gt;</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md264"></a>
3.6 virtio-blk é©±åŠ¨ (&lt;tt&gt;virtio.hpp&lt;/tt&gt; / &lt;tt&gt;virtio_blk.hpp&lt;/tt&gt;)</h2>
<div class="fragment"><div class="line"><span class="comment">// ===== virtio.hpp: VirtIO MMIO Transport =====</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">enum class</span> VirtIOStatus : uint32_t {</div>
<div class="line">  kAcknowledge = 1,</div>
<div class="line">  kDriver = 2,</div>
<div class="line">  kDriverOk = 4,</div>
<div class="line">  kFeaturesOk = 8,</div>
<div class="line">  kDeviceNeedsReset = 64,</div>
<div class="line">  kFailed = 128,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">enum class</span> VirtQueueDescFlag : uint16_t {</div>
<div class="line">  kNext = 1,     </div>
<div class="line">  kWrite = 2,    </div>
<div class="line">  kIndirect = 4, </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>VirtQueueDesc {</div>
<div class="line">  uint64_t addr;    </div>
<div class="line">  uint32_t len;     </div>
<div class="line">  uint16_t <a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a>;   </div>
<div class="line">  uint16_t next;    </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>VirtIODevice {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">auto</span> Init(uint64_t base_addr) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;void&gt;</a>;</div>
<div class="line"> </div>
<div class="line">  [[nodiscard]] <span class="keyword">auto</span> GetDeviceId() const -&gt; uint32_t;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ... VirtQueue ç®¡ç†æ–¹æ³•ï¼ˆåˆ†é…ã€é€šçŸ¥ã€å›æ”¶ï¼‰</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ===== virtio_blk.hpp: VirtIO Block Device =====</span></div>
<div class="line"> </div>
<div class="line">class VirtIOBlk : public BlockDevice {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">auto</span> Init(uint64_t base_addr, uint32_t irq) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;void&gt;</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// BlockDevice æ¥å£å®ç°</span></div>
<div class="line">  <span class="keyword">auto</span> ReadSectors(...) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;size_t&gt;</a> <span class="keyword">override</span>;</div>
<div class="line">  <span class="keyword">auto</span> WriteSectors(...) -&gt; <a class="code hl_typedef" href="expected_8hpp.html#a87330dc74eb67e824914b8d343050757">Expected&lt;size_t&gt;</a> <span class="keyword">override</span>;</div>
<div class="line">  [[nodiscard]] <span class="keyword">auto</span> GetSectorSize() const -&gt; uint32_t override;</div>
<div class="line">  [[nodiscard]] auto GetSectorCount() const -&gt; uint64_t override;</div>
<div class="line">  [[nodiscard]] auto GetName() const -&gt; const <span class="keywordtype">char</span>* override;</div>
<div class="line">};</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md266"></a>
4. ç³»ç»Ÿè°ƒç”¨æ¥å£</h1>
<p>åœ¨ <code><a class="el" href="syscall_8hpp.html">syscall.hpp</a></code> ä¸­æ–°å¢ä»¥ä¸‹ç³»ç»Ÿè°ƒç”¨å·å’Œå‡½æ•°å£°æ˜ï¼š</p>
<div class="fragment"><div class="line"><span class="comment">// ===== æ–°å¢ç³»ç»Ÿè°ƒç”¨å· =====</span></div>
<div class="line"><span class="preprocessor">#if defined(__riscv) || defined(__aarch64__)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_OPENAT  = 56;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_CLOSE   = 57;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_READ    = 63;</div>
<div class="line"><span class="comment">// SYSCALL_WRITE = 64 å·²å­˜åœ¨</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_LSEEK   = 62;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_MOUNT   = 40;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_UMOUNT  = 39;</div>
<div class="line"><span class="preprocessor">#elif defined(__x86_64__)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_OPEN    = 2;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_CLOSE   = 3;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_READ    = 0;</div>
<div class="line"><span class="comment">// SYSCALL_WRITE = 1 å·²å­˜åœ¨</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_LSEEK   = 8;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_MOUNT   = 165;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> uint64_t SYSCALL_UMOUNT  = 166;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ===== ç³»ç»Ÿè°ƒç”¨å‡½æ•° =====</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> sys_open(<span class="keyword">const</span> <span class="keywordtype">char</span>* path, uint32_t <a class="code hl_variable" href="acpi_8h.html#a773b39d480759f67926cb18ae2219281">flags</a>, uint32_t mode);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> sys_close(<span class="keywordtype">int</span> fd);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> sys_read(<span class="keywordtype">int</span> fd, <span class="keywordtype">void</span>* buf, <span class="keywordtype">size_t</span> count);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// sys_write å·²å­˜åœ¨ï¼Œéœ€è¦æ‰©å±•ä»¥æ”¯æŒé€šè¿‡ VFS å†™æ–‡ä»¶</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> sys_lseek(<span class="keywordtype">int</span> fd, int64_t offset, <span class="keywordtype">int</span> whence);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> sys_mount(<span class="keyword">const</span> <span class="keywordtype">char</span>* source, <span class="keyword">const</span> <span class="keywordtype">char</span>* target, <span class="keyword">const</span> <span class="keywordtype">char</span>* fstype);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> sys_umount(<span class="keyword">const</span> <span class="keywordtype">char</span>* target);</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md268"></a>
5. æ”¹åŠ¨èŒƒå›´</h1>
<h2><a class="anchor" id="autotoc_md269"></a>
5.1 æ–°å¢æ–‡ä»¶</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">æ–‡ä»¶   </th><th class="markdownTableHeadNone">è¯´æ˜    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/fs/CMakeLists.txt</code>   </td><td class="markdownTableBodyNone">æ–‡ä»¶ç³»ç»Ÿå­ç³»ç»Ÿæ„å»ºè„šæœ¬    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/fs/include/block_device.hpp</code>   </td><td class="markdownTableBodyNone">å—è®¾å¤‡æŠ½è±¡æ¥å£    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/fs/include/vfs.hpp</code>   </td><td class="markdownTableBodyNone">VFS æ ¸å¿ƒæ•°æ®ç»“æ„    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/fs/include/filesystem.hpp</code>   </td><td class="markdownTableBodyNone">æ–‡ä»¶ç³»ç»ŸåŸºç±»    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/fs/include/file_descriptor.hpp</code>   </td><td class="markdownTableBodyNone">æ–‡ä»¶æè¿°ç¬¦è¡¨    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/fs/include/mount.hpp</code>   </td><td class="markdownTableBodyNone">æŒ‚è½½ç®¡ç†    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/fs/vfs.cpp</code>   </td><td class="markdownTableBodyNone">VFS è·¯å¾„è§£æã€inode ç¼“å­˜ç­‰å®ç°    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/fs/file_descriptor.cpp</code>   </td><td class="markdownTableBodyNone">FdTable å®ç°    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/fs/mount.cpp</code>   </td><td class="markdownTableBodyNone">MountTable å®ç°    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/fs/ramfs/CMakeLists.txt</code>   </td><td class="markdownTableBodyNone">ramfs æ„å»ºè„šæœ¬    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/fs/ramfs/include/ramfs.hpp</code>   </td><td class="markdownTableBodyNone">ramfs æ¥å£    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/fs/ramfs/ramfs.cpp</code>   </td><td class="markdownTableBodyNone">ramfs å®ç°    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/fs/fat32/CMakeLists.txt</code>   </td><td class="markdownTableBodyNone">FAT32 æ„å»ºè„šæœ¬    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/fs/fat32/include/fat32.hpp</code>   </td><td class="markdownTableBodyNone">FAT32 æ¥å£    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/fs/fat32/fat32.cpp</code>   </td><td class="markdownTableBodyNone">FAT32 å®ç°    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/driver/virtio/CMakeLists.txt</code>   </td><td class="markdownTableBodyNone">virtio é©±åŠ¨æ„å»ºè„šæœ¬    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/driver/virtio/include/virtio.hpp</code>   </td><td class="markdownTableBodyNone">virtio MMIO transport æ¥å£    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/driver/virtio/include/virtio_blk.hpp</code>   </td><td class="markdownTableBodyNone">virtio-blk æ¥å£    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/driver/virtio/virtio.cpp</code>   </td><td class="markdownTableBodyNone">virtio MMIO transport å®ç°    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/driver/virtio/virtio_blk.cpp</code>   </td><td class="markdownTableBodyNone">virtio-blk é©±åŠ¨å®ç°    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>tests/unit_test/vfs_test.cpp</code>   </td><td class="markdownTableBodyNone">VFS å•å…ƒæµ‹è¯•    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>tests/unit_test/ramfs_test.cpp</code>   </td><td class="markdownTableBodyNone">ramfs å•å…ƒæµ‹è¯•    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>tests/unit_test/fat32_test.cpp</code>   </td><td class="markdownTableBodyNone">FAT32 å•å…ƒæµ‹è¯•    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>tests/system_test/fs_test.cpp</code>   </td><td class="markdownTableBodyNone">æ–‡ä»¶ç³»ç»Ÿç³»ç»Ÿæµ‹è¯•    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>tests/system_test/virtio_blk_test.cpp</code>   </td><td class="markdownTableBodyNone">virtio-blk ç³»ç»Ÿæµ‹è¯•   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md270"></a>
5.2 éœ€ä¿®æ”¹çš„å·²æœ‰æ–‡ä»¶</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">æ–‡ä»¶   </th><th class="markdownTableHeadNone">ä¿®æ”¹å†…å®¹    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/CMakeLists.txt</code>   </td><td class="markdownTableBodyNone">æ·»åŠ  <code>ADD_SUBDIRECTORY(fs)</code>ï¼Œé“¾æ¥ <code>fs</code> åº“    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/driver/CMakeLists.txt</code>   </td><td class="markdownTableBodyNone">æ·»åŠ  <code>virtio</code> å­ç›®å½•ï¼ˆä¸‰æ¶æ„é€šç”¨ï¼‰    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code><a class="el" href="syscall_8hpp.html">src/include/syscall.hpp</a></code>   </td><td class="markdownTableBodyNone">æ–°å¢æ–‡ä»¶ç³»ç»Ÿç›¸å…³ç³»ç»Ÿè°ƒç”¨å·å’Œå‡½æ•°å£°æ˜    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code><a class="el" href="syscall_8cpp.html">src/syscall.cpp</a></code>   </td><td class="markdownTableBodyNone">æ–°å¢ç³»ç»Ÿè°ƒç”¨åˆ†å‘å’Œå®ç°ï¼ˆopen/close/read/write/lseek/mount/umountï¼‰    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code><a class="el" href="expected_8hpp.html">src/include/expected.hpp</a></code>   </td><td class="markdownTableBodyNone">æ–°å¢æ–‡ä»¶ç³»ç»Ÿç›¸å…³é”™è¯¯ç ï¼ˆ0x800-0x8FF, 0x900-0x9FFï¼‰    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code><a class="el" href="task__control__block_8hpp.html">src/task/include/task_control_block.hpp</a></code>   </td><td class="markdownTableBodyNone">æ·»åŠ  <code>FdTable* fd_table</code> å­—æ®µ    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code><a class="el" href="src_2main_8cpp.html">src/main.cpp</a></code>   </td><td class="markdownTableBodyNone">åˆå§‹åŒ– VFSã€æŒ‚è½½ rootfs (ramfs)ã€åˆå§‹åŒ– virtio è®¾å¤‡    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>cmake/functions.cmake</code>   </td><td class="markdownTableBodyNone">QEMU å¯åŠ¨å‚æ•°æ·»åŠ  virtio-blk è®¾å¤‡    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code><a class="el" href="basic__info_8hpp.html">src/include/basic_info.hpp</a></code>   </td><td class="markdownTableBodyNone">ï¼ˆå¯é€‰ï¼‰æ·»åŠ å—è®¾å¤‡ä¿¡æ¯å­—æ®µ    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>tests/unit_test/CMakeLists.txt</code>   </td><td class="markdownTableBodyNone">æ·»åŠ æ–°æµ‹è¯•æ–‡ä»¶    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>tests/system_test/CMakeLists.txt</code>   </td><td class="markdownTableBodyNone">æ·»åŠ æ–°æµ‹è¯•æ–‡ä»¶   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md271"></a>
5.3 QEMU é…ç½®å˜æ›´</h2>
<p>éœ€è¦ä¸ºæ¯ä¸ªæ¶æ„æ·»åŠ  virtio-blk è®¾å¤‡å‚æ•°ï¼š</p>
<div class="fragment"><div class="line"># é€šç”¨ï¼šåˆ›å»ºç£ç›˜é•œåƒ</div>
<div class="line">ADD_CUSTOM_COMMAND(</div>
<div class="line">  OUTPUT ${CMAKE_BINARY_DIR}/bin/disk.img</div>
<div class="line">  COMMAND dd if=/dev/zero of=${CMAKE_BINARY_DIR}/bin/disk.img bs=1M count=64</div>
<div class="line">  COMMAND mkfs.fat -F 32 ${CMAKE_BINARY_DIR}/bin/disk.img</div>
<div class="line">  COMMENT &quot;Creating FAT32 disk image&quot;</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line"># QEMU å‚æ•°è¿½åŠ ï¼ˆä¸‰æ¶æ„é€šç”¨ï¼‰</div>
<div class="line">LIST(APPEND ${PROJECT_NAME}_QEMU_BOOT_FLAGS</div>
<div class="line">  -drive file=${CMAKE_BINARY_DIR}/bin/disk.img,if=none,format=raw,id=hd0</div>
<div class="line">  -device virtio-blk-device,drive=hd0</div>
<div class="line">)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md272"></a>
5.4 æ–°å¢é”™è¯¯ç </h2>
<div class="fragment"><div class="line"><span class="comment">// æ–‡ä»¶ç³»ç»Ÿç›¸å…³é”™è¯¯ (0x800 - 0x8FF)</span></div>
<div class="line">kFsFileNotFound = 0x800,</div>
<div class="line">kFsPermissionDenied = 0x801,</div>
<div class="line">kFsNotADirectory = 0x802,</div>
<div class="line">kFsIsADirectory = 0x803,</div>
<div class="line">kFsFileExists = 0x804,</div>
<div class="line">kFsNoSpace = 0x805,</div>
<div class="line">kFsMountFailed = 0x806,</div>
<div class="line">kFsUnmountFailed = 0x807,</div>
<div class="line">kFsInvalidPath = 0x808,</div>
<div class="line">kFsFdTableFull = 0x809,</div>
<div class="line">kFsInvalidFd = 0x80A,</div>
<div class="line">kFsNotMounted = 0x80B,</div>
<div class="line">kFsReadOnly = 0x80C,</div>
<div class="line">kFsCorrupted = 0x80D,</div>
<div class="line"> </div>
<div class="line"><span class="comment">// å—è®¾å¤‡ç›¸å…³é”™è¯¯ (0x900 - 0x9FF)</span></div>
<div class="line">kBlkDeviceNotFound = 0x900,</div>
<div class="line">kBlkReadFailed = 0x901,</div>
<div class="line">kBlkWriteFailed = 0x902,</div>
<div class="line">kBlkSectorOutOfRange = 0x903,</div>
<div class="line"> </div>
<div class="line"><span class="comment">// VirtIO ç›¸å…³é”™è¯¯ (0xA00 - 0xAFF)</span></div>
<div class="line">kVirtIOInitFailed = 0xA00,</div>
<div class="line">kVirtIONotBlock = 0xA01,</div>
<div class="line">kVirtIOQueueFull = 0xA02,</div>
<div class="line">kVirtIODeviceError = 0xA03,</div>
<div class="line">kVirtIOFeatureNegotiationFailed = 0xA04,</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md274"></a>
6. è¯¦ç»†å®ç°è®¡åˆ’</h1>
<h2><a class="anchor" id="autotoc_md275"></a>
P0: å—è®¾å¤‡æ¥å£ + virtio-blk é©±åŠ¨</h2>
<p>**ç›®æ ‡**ï¼šèƒ½åœ¨ QEMU ä¸­é€šè¿‡ virtio-blk è¯»å†™ç£ç›˜æ‰‡åŒºã€‚</p>
<h3><a class="anchor" id="autotoc_md276"></a>
æ­¥éª¤</h3>
<ol type="1">
<li><b>å®šä¹‰ <code>BlockDevice</code> æŠ½è±¡æ¥å£</b> (<code>src/fs/include/block_device.hpp</code>)</li>
<li><b>å®ç° VirtIO MMIO transport</b> (<code>src/driver/virtio/virtio.cpp</code>)<ul>
<li>MMIO å¯„å­˜å™¨è¯»å†™ï¼ˆMagic, Version, DeviceID, Status ç­‰ï¼‰</li>
<li>VirtQueue åˆ†é…å’Œåˆå§‹åŒ–ï¼ˆæè¿°ç¬¦è¡¨ã€Available Ringã€Used Ringï¼‰</li>
<li>è®¾å¤‡åˆå§‹åŒ–æ¡æ‰‹æµç¨‹ï¼ˆReset â†’ Acknowledge â†’ Driver â†’ Features â†’ DriverOkï¼‰</li>
<li>VirtQueue é€šçŸ¥ï¼ˆå†™ QueueNotify å¯„å­˜å™¨ï¼‰å’Œå›æ”¶ï¼ˆè½®è¯¢/ä¸­æ–­ï¼‰</li>
</ul>
</li>
<li><b>å®ç° VirtIO-Blk é©±åŠ¨</b> (<code>src/driver/virtio/virtio_blk.cpp</code>)<ul>
<li>ç»§æ‰¿ <code>BlockDevice</code></li>
<li>è¯»å–è®¾å¤‡é…ç½®ï¼ˆå®¹é‡ã€æ‰‡åŒºå¤§å°ï¼‰</li>
<li>æ„é€  <code>VirtIOBlkReq</code>ï¼ˆtype + sector + data + statusï¼‰</li>
<li>å®ç° <code>ReadSectors</code> / <code>WriteSectors</code></li>
</ul>
</li>
<li><b>è®¾å¤‡å‘ç°</b><ul>
<li>é€šè¿‡ <code><a class="el" href="classKernelFdt.html">KernelFdt</a></code> è§£æ FDTï¼ŒæŸ¥æ‰¾ <code>compatible = "virtio,mmio"</code> èŠ‚ç‚¹</li>
<li>è¯»å– <code>reg</code> å±æ€§è·å– MMIO åŸºåœ°å€ï¼Œ<code>interrupts</code> å±æ€§è·å–ä¸­æ–­å·</li>
<li>è°ƒç”¨ <code><a class="el" href="classVirtualMemory.html#a19ea83e0f3f85e55b12deec2a20972a2" title="æ˜ å°„è®¾å¤‡å†…å­˜ (MMIO)">VirtualMemory::MapMMIO</a></code> æ˜ å°„è®¾å¤‡åœ°å€ç©ºé—´</li>
</ul>
</li>
<li><b>QEMU é…ç½®</b><ul>
<li>ä¿®æ”¹ CMake æ·»åŠ ç£ç›˜é•œåƒç”Ÿæˆå’Œ QEMU virtio-blk å‚æ•°</li>
</ul>
</li>
<li><b>ç³»ç»Ÿæµ‹è¯•</b><ul>
<li>åœ¨ QEMU ä¸­è¯»å–å·²çŸ¥å†…å®¹çš„æ‰‡åŒºï¼ŒéªŒè¯æ•°æ®æ­£ç¡®æ€§</li>
</ul>
</li>
</ol>
<h3><a class="anchor" id="autotoc_md277"></a>
å…³é”®æŠ€æœ¯ç‚¹</h3>
<ul>
<li>VirtIO MMIO å¯„å­˜å™¨åç§»å‚è€ƒ <a href="https://docs.oasis-open.org/virtio/virtio/v1.2/virtio-v1.2.html">VirtIO 1.2 è§„èŒƒ Â§4.2.2</a></li>
<li>VirtQueue å†…å­˜éœ€è¦ç‰©ç†åœ°å€è¿ç»­ï¼Œä½¿ç”¨ <code>aligned_alloc</code> åˆ†é…</li>
<li>å½“å‰å¯ä½¿ç”¨**è½®è¯¢æ¨¡å¼**ï¼ˆpollingï¼‰ï¼Œåç»­å¯æ‰©å±•ä¸ºä¸­æ–­é©±åŠ¨</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md279"></a>
P1: VFS æ¡†æ¶</h2>
<p>**ç›®æ ‡**ï¼šå»ºç«‹ Inode / Dentry / File æŠ½è±¡å±‚å’Œè·¯å¾„è§£ææœºåˆ¶ã€‚</p>
<h3><a class="anchor" id="autotoc_md280"></a>
æ­¥éª¤</h3>
<ol type="1">
<li><b>å®šä¹‰ VFS æ ¸å¿ƒç»“æ„ä½“</b> (<code>src/fs/include/vfs.hpp</code>)<ul>
<li><code>Inode</code>ã€<code>Dentry</code>ã€<code>File</code>ã€<code>InodeOps</code>ã€<code>FileOps</code></li>
</ul>
</li>
<li><b>å®ç°è·¯å¾„è§£æ</b> (<code>src/fs/vfs.cpp</code>)<ul>
<li><code>VfsLookup(const char* path) -&gt; Expected&lt;Dentry*&gt;</code></li>
<li>å°† <code>/a/b/c</code> æ‹†åˆ†ä¸ºå„çº§ç»„ä»¶ï¼Œé€çº§æŸ¥æ‰¾</li>
<li>é‡åˆ°æŒ‚è½½ç‚¹æ—¶åˆ‡æ¢åˆ°å­æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ Dentry</li>
</ul>
</li>
<li><b>å®ç° Dentry æ ‘ç®¡ç†</b><ul>
<li><code>DentryCreate</code> / <code>DentryLookupChild</code> / <code>DentryInsertChild</code></li>
</ul>
</li>
<li><b>å®ç°å…¨å±€ VFS æ“ä½œ</b><ul>
<li><code>VfsOpen(path, flags) -&gt; Expected&lt;File*&gt;</code></li>
<li><code>VfsClose(File*) -&gt; Expected&lt;void&gt;</code></li>
<li><code>VfsRead(File*, buf, count) -&gt; Expected&lt;size_t&gt;</code></li>
<li><code>VfsWrite(File*, buf, count) -&gt; Expected&lt;size_t&gt;</code></li>
<li><code>VfsMount(path, FileSystem*, BlockDevice*) -&gt; Expected&lt;void&gt;</code></li>
</ul>
</li>
<li>**Inode ç¼“å­˜**ï¼ˆç®€åŒ–ç‰ˆï¼šç›´æ¥åœ¨ Dentry ä¸­ä¿å­˜ï¼Œä¸åšé¢å¤–å“ˆå¸Œè¡¨ç¼“å­˜ï¼‰</li>
</ol>
<hr  />
<h2><a class="anchor" id="autotoc_md282"></a>
P2: ramfs</h2>
<p>**ç›®æ ‡**ï¼šçº¯å†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œä½œä¸º rootfs æŒ‚è½½ï¼ŒéªŒè¯ VFS æ­£ç¡®æ€§ã€‚</p>
<h3><a class="anchor" id="autotoc_md283"></a>
æ­¥éª¤</h3>
<ol type="1">
<li><b>å®šä¹‰ ramfs æ¥å£</b> (<code>src/fs/ramfs/include/ramfs.hpp</code>)<ul>
<li><code>class RamFs : public FileSystem</code></li>
</ul>
</li>
<li><b>å®ç° InodeOps</b><ul>
<li><code>lookup</code>ï¼šåœ¨å†…å­˜ä¸­çš„å­èŠ‚ç‚¹åˆ—è¡¨æŸ¥æ‰¾</li>
<li><code>create</code>ï¼šåˆ†é…æ–° inodeï¼Œåˆå§‹åŒ–æ•°æ®ç¼“å†²åŒº</li>
<li><code>mkdir</code>ï¼šåˆ†é…æ–°ç›®å½• inode</li>
<li><code>unlink</code> / <code>rmdir</code>ï¼šé‡Šæ”¾ inode åŠæ•°æ®</li>
</ul>
</li>
<li><b>å®ç° FileOps</b><ul>
<li><code>read</code>ï¼šä»å†…å­˜ç¼“å†²åŒºå¤åˆ¶æ•°æ®</li>
<li><code>write</code>ï¼šæ‰©å±•å†…å­˜ç¼“å†²åŒºå¹¶å†™å…¥</li>
<li><code>readdir</code>ï¼šéå†ç›®å½•å­é¡¹</li>
</ul>
</li>
<li><b>æ•°æ®å­˜å‚¨</b><ul>
<li>ä½¿ç”¨åŠ¨æ€æ•°ç»„ï¼ˆ<code>sk_vector</code>ï¼‰æˆ–é“¾è¡¨ï¼ˆ<code>sk_list</code>ï¼‰å­˜å‚¨æ–‡ä»¶å†…å®¹</li>
<li>ç›®å½•ç”¨å­èŠ‚ç‚¹é“¾è¡¨</li>
</ul>
</li>
<li><b>æµ‹è¯•</b><ul>
<li>å•å…ƒæµ‹è¯•ï¼šåˆ›å»º/åˆ é™¤æ–‡ä»¶ã€è¯»å†™éªŒè¯ã€ç›®å½•æ“ä½œ</li>
<li>ç³»ç»Ÿæµ‹è¯•ï¼šåœ¨ QEMU ä¸­æŒ‚è½½ ramfs åˆ° <code>/</code>ï¼Œåˆ›å»ºæ–‡ä»¶å¹¶è¯»å›</li>
</ul>
</li>
</ol>
<hr  />
<h2><a class="anchor" id="autotoc_md285"></a>
P3: FAT32</h2>
<p>**ç›®æ ‡**ï¼šèƒ½è¯»å†™ QEMU virtio-blk ä¸Šçš„ FAT32 æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<h3><a class="anchor" id="autotoc_md286"></a>
æ­¥éª¤</h3>
<ol type="1">
<li><b>å®šä¹‰ FAT32 ç£ç›˜æ•°æ®ç»“æ„</b> (<code>src/fs/fat32/include/fat32.hpp</code>)<ul>
<li>BPBï¼ˆBIOS Parameter Blockï¼‰</li>
<li>FSInfo æ‰‡åŒº</li>
<li>FAT è¡¨é¡¹</li>
<li>ç›®å½•é¡¹ï¼ˆçŸ­å + é•¿åï¼‰</li>
</ul>
</li>
<li><b>å®ç° <code>Fat32Fs : public FileSystem</code></b><ul>
<li><code>Mount</code>ï¼šè¯»å– BPBã€FAT è¡¨ï¼Œæ„å»ºæ ¹ç›®å½• inode</li>
<li><code>Unmount</code>ï¼šåˆ·å†™è„æ•°æ®</li>
<li><code>Sync</code>ï¼šåˆ·å†™ FAT è¡¨å’Œè„ç›®å½•é¡¹</li>
</ul>
</li>
<li><b>å®ç° InodeOps</b><ul>
<li><code>lookup</code>ï¼šè¯»å–ç›®å½•ç°‡é“¾ï¼Œè§£æç›®å½•é¡¹</li>
<li><code>create</code>ï¼šåˆ†é…ç©ºé—²ç°‡ï¼Œå†™å…¥ç›®å½•é¡¹</li>
<li><code>unlink</code>ï¼šæ ‡è®°ç›®å½•é¡¹åˆ é™¤ï¼Œé‡Šæ”¾ FAT é“¾</li>
</ul>
</li>
<li><b>å®ç° FileOps</b><ul>
<li><code>read</code>ï¼šæ²¿ FAT é“¾è¯»å–æ•°æ®ç°‡</li>
<li><code>write</code>ï¼šåˆ†é…æ–°ç°‡ã€æ‰©å±• FAT é“¾ã€å†™å…¥æ•°æ®</li>
<li><code>seek</code>ï¼šè®¡ç®—ç›®æ ‡ç°‡å’Œåç§»</li>
</ul>
</li>
<li><b>FAT è¡¨ç®¡ç†</b><ul>
<li>è¯»å– FAT è¡¨åˆ°å†…å­˜ç¼“å­˜</li>
<li>åˆ†é…/é‡Šæ”¾ç°‡ï¼ˆé¦–æ¬¡é€‚é…ç®—æ³•ï¼‰</li>
<li>è„æ ‡è®° + å®šæœŸå†™å›</li>
</ul>
</li>
<li><b>é•¿æ–‡ä»¶åæ”¯æŒ**ï¼ˆå¯é€‰ï¼ŒP3 åæœŸï¼‰<ul>
<li>è§£æ LFN ç›®å½•é¡¹åºåˆ—</li>
<li>æ‹¼æ¥æˆå®Œæ•´æ–‡ä»¶å</li>
</ul>
</b></li>
<li><b>**æµ‹è¯•</b><ul>
<li>å•å…ƒæµ‹è¯•ï¼šä½¿ç”¨ mock BlockDevice + é¢„æ„é€ çš„ FAT32 é•œåƒ</li>
<li>ç³»ç»Ÿæµ‹è¯•ï¼šåœ¨ QEMU ä¸­æŒ‚è½½ virtio-blk ä¸Šçš„ FAT32ï¼Œè¯»å†™æ–‡ä»¶</li>
</ul>
</li>
</ol>
<hr  />
<h2><a class="anchor" id="autotoc_md288"></a>
P4: ç³»ç»Ÿè°ƒç”¨é›†æˆ</h2>
<p>**ç›®æ ‡**ï¼šç”¨æˆ·æ€å¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<h3><a class="anchor" id="autotoc_md289"></a>
æ­¥éª¤</h3>
<ol type="1">
<li><b>ä¸º <code><a class="el" href="structTaskControlBlock.html" title="ä»»åŠ¡æ§åˆ¶å—ï¼Œç®¡ç†è¿›ç¨‹/çº¿ç¨‹çš„æ ¸å¿ƒæ•°æ®ç»“æ„">TaskControlBlock</a></code> æ·»åŠ  <code>FdTable</code></b><ul>
<li>åˆå§‹åŒ–æ—¶é¢„è®¾ fd 0/1/2 æŒ‡å‘æ§åˆ¶å°</li>
</ul>
</li>
<li><b>å®ç°æ–‡ä»¶ç³»ç»Ÿç›¸å…³ç³»ç»Ÿè°ƒç”¨</b><ul>
<li><code>sys_open</code> â†’ <code>VfsOpen</code> â†’ <code>FdTable::Alloc</code></li>
<li><code>sys_close</code> â†’ <code>FdTable::Get</code> â†’ <code>VfsClose</code> â†’ <code>FdTable::Free</code></li>
<li><code>sys_read</code> â†’ <code>FdTable::Get</code> â†’ <code>VfsRead</code></li>
<li><code>sys_write</code> æ‰©å±•ï¼šfd == 1/2 èµ°åŸé€»è¾‘ï¼Œå…¶ä»–èµ° <code>VfsWrite</code></li>
<li><code>sys_lseek</code> â†’ <code>File::ops-&gt;seek</code></li>
<li><code>sys_mount</code> / <code>sys_umount</code> â†’ <code>MountTable</code></li>
</ul>
</li>
<li><b>æ³¨å†Œåˆ° <code>syscall_dispatcher</code></b></li>
<li><b>æµ‹è¯•</b><ul>
<li>ç³»ç»Ÿæµ‹è¯•ï¼šé€šè¿‡ <code>ecall/syscall</code> æŒ‡ä»¤è§¦å‘æ–‡ä»¶æ“ä½œ</li>
</ul>
</li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md291"></a>
7. å…³é”®è®¾è®¡å†³ç­–</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">å†³ç­–ç‚¹   </th><th class="markdownTableHeadNone">é€‰æ‹©   </th><th class="markdownTableHeadNone">ç†ç”±    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">VirtIO transport   </td><td class="markdownTableBodyNone">MMIOï¼ˆé PCIï¼‰   </td><td class="markdownTableBodyNone">QEMU virt å¹³å°é»˜è®¤ä½¿ç”¨ MMIOï¼›ä¸‰æ¶æ„ç»Ÿä¸€    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">I/O æ¨¡å¼   </td><td class="markdownTableBodyNone">è½®è¯¢ä¼˜å…ˆï¼Œåç»­åŠ ä¸­æ–­   </td><td class="markdownTableBodyNone">ç®€åŒ–åˆå§‹å®ç°ï¼Œé™ä½è°ƒè¯•éš¾åº¦    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ç£ç›˜ç¼“å­˜   </td><td class="markdownTableBodyNone">ç®€å•æ‰‡åŒºç¼“å­˜   </td><td class="markdownTableBodyNone">å…ˆä¸åš page cacheï¼Œé™ä½å¤æ‚åº¦    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ramfs å†…å­˜ç®¡ç†   </td><td class="markdownTableBodyNone"><code>aligned_alloc</code> + <code>sk_vector</code>   </td><td class="markdownTableBodyNone">å¤ç”¨é¡¹ç›®å·²æœ‰çš„å†…å­˜åˆ†é…åŸºç¡€è®¾æ–½    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Dentry ç¼“å­˜   </td><td class="markdownTableBodyNone">é“¾è¡¨   </td><td class="markdownTableBodyNone">æ–‡ä»¶æ•°é‡æœ‰é™çš„æ•™å­¦å†…æ ¸ï¼Œé¿å…è¿‡åº¦è®¾è®¡    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">FAT è¡¨ç¼“å­˜   </td><td class="markdownTableBodyNone">å…¨é‡åŠ è½½åˆ°å†…å­˜   </td><td class="markdownTableBodyNone">64MB ç£ç›˜çš„ FAT è¡¨çº¦ 128KBï¼Œå®Œå…¨å¯æ§    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">æ–‡ä»¶æè¿°ç¬¦ä¸Šé™   </td><td class="markdownTableBodyNone">64   </td><td class="markdownTableBodyNone">æ•™å­¦å†…æ ¸å¤Ÿç”¨ï¼Œé¿å…å¤æ‚æ•°æ®ç»“æ„    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">é•¿æ–‡ä»¶å   </td><td class="markdownTableBodyNone">å»¶åæ”¯æŒ   </td><td class="markdownTableBodyNone">çŸ­åï¼ˆ8.3ï¼‰è¶³ä»¥éªŒè¯æ ¸å¿ƒåŠŸèƒ½   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md293"></a>
8. æµ‹è¯•ç­–ç•¥</h1>
<h2><a class="anchor" id="autotoc_md294"></a>
å•å…ƒæµ‹è¯•ï¼ˆHost è¿è¡Œï¼‰</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">æµ‹è¯•æ–‡ä»¶   </th><th class="markdownTableHeadNone">è¦†ç›–å†…å®¹    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>vfs_test.cpp</code>   </td><td class="markdownTableBodyNone">è·¯å¾„è§£æã€Dentry æ ‘æ“ä½œã€FdTable åˆ†é…/é‡Šæ”¾    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>ramfs_test.cpp</code>   </td><td class="markdownTableBodyNone">æ–‡ä»¶åˆ›å»º/åˆ é™¤ã€è¯»å†™ã€ç›®å½•éå†ã€è¾¹ç•Œæ¡ä»¶    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>fat32_test.cpp</code>   </td><td class="markdownTableBodyNone">BPB è§£æã€FAT é“¾éå†ã€ç›®å½•é¡¹è§£æã€ç°‡åˆ†é…ï¼ˆmock å—è®¾å¤‡ï¼‰   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md295"></a>
ç³»ç»Ÿæµ‹è¯•ï¼ˆQEMU è¿è¡Œï¼‰</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">æµ‹è¯•æ–‡ä»¶   </th><th class="markdownTableHeadNone">è¦†ç›–å†…å®¹    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>virtio_blk_test.cpp</code>   </td><td class="markdownTableBodyNone">è®¾å¤‡å‘ç°ã€æ‰‡åŒºè¯»å†™ã€è¾¹ç•Œæ‰‡åŒº    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>fs_test.cpp</code>   </td><td class="markdownTableBodyNone">ramfs æŒ‚è½½ + æ–‡ä»¶æ“ä½œã€FAT32 æŒ‚è½½ + è·¨ç°‡è¯»å†™ã€mount/umount   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md297"></a>
9. é‡Œç¨‹ç¢‘ä¸å·¥ä½œé‡ä¼°ç®—</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">é‡Œç¨‹ç¢‘   </th><th class="markdownTableHeadNone">é¢„ä¼°å·¥ä½œ   </th><th class="markdownTableHeadNone">éªŒæ”¶æ ‡å‡†    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">M0: BlockDevice + virtio-blk   </td><td class="markdownTableBodyNone">~800 è¡Œä»£ç    </td><td class="markdownTableBodyNone">QEMU ä¸­èƒ½è¯»å†™ç£ç›˜æ‰‡åŒºå¹¶æ‰“å°å†…å®¹    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">M1: VFS æ¡†æ¶   </td><td class="markdownTableBodyNone">~600 è¡Œä»£ç    </td><td class="markdownTableBodyNone">è·¯å¾„è§£æã€Dentry æ ‘ã€File æ“ä½œæµç¨‹å¯èµ°é€š    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">M2: ramfs   </td><td class="markdownTableBodyNone">~400 è¡Œä»£ç    </td><td class="markdownTableBodyNone">èƒ½æŒ‚è½½ ramfs åˆ° <code>/</code>ï¼Œåˆ›å»ºæ–‡ä»¶ã€å†™å…¥ã€è¯»å›    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">M3: FAT32   </td><td class="markdownTableBodyNone">~1000 è¡Œä»£ç    </td><td class="markdownTableBodyNone">èƒ½æŒ‚è½½ virtio-blk ä¸Šçš„ FAT32ï¼Œè¯»å†™æ–‡ä»¶    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">M4: ç³»ç»Ÿè°ƒç”¨   </td><td class="markdownTableBodyNone">~300 è¡Œä»£ç    </td><td class="markdownTableBodyNone">ç”¨æˆ·æ€é€šè¿‡ syscall å®Œæˆ open/read/write/close    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>æ€»è®¡</b>   </td><td class="markdownTableBodyNone">**~3100 è¡Œä»£ç **   </td><td class="markdownTableBodyNone">å®Œæ•´æ–‡ä»¶ç³»ç»Ÿæ ˆå¯ç”¨   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md299"></a>
10. å‚è€ƒèµ„æ–™</h1>
<ul>
<li><a href="https://docs.oasis-open.org/virtio/virtio/v1.2/virtio-v1.2.html">VirtIO 1.2 è§„èŒƒ</a> â€” Â§2 (åŸºæœ¬è®¾æ–½), Â§4.2 (MMIO), Â§5.2 (Block Device)</li>
<li><a href="https://academy.cba.mit.edu/classes/networking_communications/SD/FAT.pdf">Microsoft FAT32 è§„èŒƒ</a> â€” BPB, FAT, Directory Entry</li>
<li><a href="https://www.kernel.org/doc/html/latest/filesystems/vfs.html">Linux VFS æ–‡æ¡£</a> â€” è®¾è®¡å‚è€ƒï¼ˆä¸éœ€è¦å®Œå…¨å¤åˆ¶ï¼‰</li>
<li><a href="https://github.com/mit-pdos/xv6-riscv">xv6-riscv</a> â€” ç®€æ´æ–‡ä»¶ç³»ç»Ÿå®ç°å‚è€ƒ</li>
<li><a href="https://wiki.osdev.org/Virtio">OSDev Wiki: VirtIO</a> â€” ç¤¾åŒºé©±åŠ¨å¼€å‘æŒ‡å— </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
